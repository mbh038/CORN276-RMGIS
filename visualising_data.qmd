# Visualising data

```{r}
#| include: false
source("_common.R")
```

\vspace{-10mm}

```{r, include = FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)
```

When we have got our data safely tucked into a spreadsheet. Now we need to tease out of it the answers to our question(s) and to decide whether we have evidence enough to reject our null hypotheses, or not, in which case we will fail to reject them.

```{r, include = FALSE}
library(tidyverse)
library(palmerpenguins)
library(janitor)
library(ggfortify)
library(ggridges)
library(kableExtra)
library(cowplot)
set_theme(theme_cowplot() + theme(legend.position = "none"))
```

```{r}
# we use the fabulous openintro here only for its colour scheme
library(openintro)
data(COL)
fill_colour1<-COL['blue','f3']
# fill_colour1 <- "#b3cde3"
fill_colour2<-COL['red','f6']
fill_colour3<-COL['blue','f1']
line_colour<-COL['blue','full']
func_colour<-"darkblue"
point_colour<-COL['blue','full']
error_colour<-COL['red','full']
```

```{r, include = FALSE}
female_penguins <- penguins |>
  drop_na() |>
  mutate(species = factor(species, levels = c("Chinstrap", "Gentoo", "Adelie"))) |>
  filter(sex == "female")
```

Let's take the example of the Palmer penguins dataset. This set contains measurements of bill depth, bill length, flipper length and body mass of males and females of three species of penguins: Adelie, Chinstrap and Gentoo observed on any one of three islands in the Palmer Archipelago, Antarctica.

![Meet the penguins. Artwork by [Allison Horst](https://allisonhorst.com)](figures/penguins.png)

Let's consider only the females and ask the question:

**Question**: Is there any difference in body weight between the females of the three species?

from which we can generate a hypothesis:

**Hypothesis**: There is a difference in body weight between females ofthe three species.

**Null hypothesis**: There is no difference in body weight between females of the three species.

and hence a prediction of what we will find if the hypothesis is true:

**Prediction if the hypothesis is true**: The females of at least one species will have a different average body mass than those of at least one other species.

## Summarise the data

The first thing we can do to investigate our hypotheses is to summarise the data. More often than not this means caclulating three things for each sample - the sample sizes, the mean values and the standard errors of those means.

```{r}
penguin_summary <- female_penguins |> 
  group_by(species) |>
  summarise(n = n(), mean_body_mass = mean(body_mass_g), se_body_mass = round(sd(body_mass_g)/sqrt(n()),2))
penguin_summary |>
  kbl(digits = 2,
      col.names = c("Species", "N", "Mean body mass (g)", "Standard error (g)"))
  
```

::: callout-note
## Types of error bar

**standard deviations**: These tell us about the spread of values in a sample or a population. They do not systematically get bigger or smaller as the sample size increases. The standard deviation of a sample can be used as an estimate of the standard deviation of the population. We use standard deviations for *descriptive purposes*

**standard errors of the mean** These are used to indicate how precisely a sample mean estimates the true population mean. They are used for *inferential purposes*, whereby we try to infer from the sample mean the range of values in which the true population mean might be. Assuming normally distributed values, it would be very surprising if the true population means were more than two standard errors away from the sample means.

Standard errors are calculated from the standard deviations (SD) of the sample using the formula 
$\text{SE}=\frac{\text{SD}}{\sqrt{n}}$ where *n* is the sample size. This means that standard errors *do* get systematically smaller, the larger the sample. The larger the sample, the closer the sample mean is likely to be to the true population mean. Who knew?

**confidence intervals** These are also inferential tools. They tell us the range of values within which the true mean might plausibly lie, at some level of confidence, usually 95%.

If you include error bars in a plot you can use any of these three errors, depending on the story you want to tell. Whichever, just **must** state in the figure caption which of them you have used. Failing to do this can seriously mislead the reader, since they can be of very different magnitudes.
:::

The errors calculated here are **standard errors of the mean**. We use these because we want to get an idea, from our samples, of how plausible it is that the population means differ from each other. These population means could plausibly lie anywhere in the range that is our sample means plus or minus two of these standard errors.

-   Does it look as though there is evidence form the data for a difference between Adelie and Chinstrop penguins?
-   What about the Gentoos compared to either of the other two?
-   Do we have evidence to reject the null hypothesis. (Clue: yes we do!)

## Plot the data

After summarising the data, then ext thing we nearly always do in deciding what the data is telling us is to plot the data. We have several choices of how to do so and each has its pros and cons. Let's run through a few of them.

### Bar charts

```{r}
bc1 <- penguin_summary |>
  ggplot(aes(x = species, y = mean_body_mass, fill = species)) +
  geom_col(, alpha = 0.8) +
  labs(x = "Species",
       y = "Mean body mass (g)",
       title = "Rubbish!") +
  scale_fill_manual(values=c(Adelie='#fc8d59',Chinstrap='#8856a7', Gentoo='#2ca25f')) + # this line manually sets the fill colours for us
  theme(legend.position="none") 
  # scale_fill_brewer(palette = "Set2")
```

```{r}
bc2 <- bc1 +
  geom_errorbar(aes(ymin = mean_body_mass - 2*se_body_mass,
                    ymax = mean_body_mass + 2*se_body_mass),
width=0.15, colour = "grey40") +
    labs(title = "Better!",
         caption = "error bars are Â± one standard error")
```

```{r}
bc3 <- bc2 +
  geom_text(aes(y = 0, label = paste("n = ",n)), vjust = 0, nudge_y = 200) +
  labs(title = "Even better!")
```


```{r}
bc4 <- bc3 +
  geom_col(fill = fill_colour1, alpha = 1.0) +
  geom_errorbar(aes(ymin = mean_body_mass - 2*se_body_mass,
                    ymax = mean_body_mass + 2*se_body_mass),
width=0.15, colour = "grey40") +
  geom_text(aes(y = 0, label = paste("n = ",n)), vjust = 0, nudge_y = 200) +
  labs(title = "Best!")
```

```{r}
#| label: fig-bar-charts
#| fig-cap: "Bar charts, from worst to best"
#| fig-subcap: 
#|   - "Terrible!"
#|   - "Standard errors added"
#|   - "Sample sizes added"
#|   - "Redundant colours removed"
#| layout-ncol: 2

bc1
bc2
bc3
bc4
```

### Histograms

In histograms the range of a variable is split into bis of. certain width, then the number of observations that fall within each bin is displayed.

They can be used to inspect a data set, even one with multiple categories, as with the penguin data. Unlike bar charts they do show the  distribution of the dataset, including its central value, spread and symmetry, or lack thereof.

They do need care however in choice of the width of the bins. Make these too narrow and the histograms can look gappy, with too much scatter introduced by there not being many observations in each bin. Make the bins too wide and much of the detail of the distribution is lost. You need to find, approximately, the 'Goldilocks' width, one that is just right. Sometimes, though, you choose a binwidth that has meaning to you and the reader, such as widths of 1 m/s if you were doing a histogram of a set of wind speed measurements.

We illustrate that issue in @fig-histograms where we show histograms of the body masses of the Adelie females in the sample, one with bins that are too narrow (50g), one where they are about right (100g) and one where they are too wiede (200g)


```{r}
h1<- female_penguins |>
  filter(species == "Adelie") |>
ggplot(aes(x = body_mass_g)) + 
  geom_histogram(binwidth = 50, alpha = 1.0, fill = fill_colour1, colour = "grey80", linewidth = 0.5) + 
  labs(x = "Body mass (g)",
       y = "Frequency")
```

```{r}
h2<- female_penguins |>
  filter(species == "Adelie") |>
ggplot(aes(x = body_mass_g)) + 
  geom_histogram(binwidth = 100, alpha = 1.0, fill = fill_colour1, colour = "grey80", linewidth = 0.5) + 
  labs(x = "Body mass (g)",
       y = "Frequency")
```

```{r}
h3 <- female_penguins |>
  filter(species == "Adelie") |>
ggplot(aes(x = body_mass_g)) + 
  geom_histogram(binwidth = 200, alpha = 1.0, fill = fill_colour1, , colour = "grey80", linewidth = 0.5) + 
  labs(x = "Body mass (g)",
       y = "Frequency")
```

```{r}
#| label: fig-histograms
#| fig-cap: "Histograms of different bin width"
#| fig-subcap: 
#|   - "bins too narrow"
#|   - "Bin width about right"
#|   - "Bins too wide"
#| layout-ncol: 3

h1
h2
h3
```
As for our hypotheses, if we plot histograms of the body masses of the females, one for each species, and put display them in a column, one on top of the other, we get some insight as to whether we are likely to reject our null hypothesis, or fail to reject it.

```{r}
female_penguins |>
  ggplot(aes(x = body_mass_g)) +
  geom_histogram(binwidth = 100, alpha = 1.0, fill = fill_colour1, colour = "grey80", linewidth = 0.5) +
  labs(x = "Body mass (g)",
       y = "Frequency") +
  facet_wrap(~species,ncol = 1) +
  scale_fill_brewer(palette = "Set1") +
  theme(strip.background = element_blank())
```

Unlike the bar charts, histograms also tell us about the shape and widths of the distributions of the three data sets. When we do actually use a statistics test to make a decision about our hypotheses, these features of the data will be very important in helping us decide which test is the right one.

### Box plots

A very useful plot type for help in answering difference questions is the box and whisker plot, often just called a box plot. We normally use them where we have continuous data spread across one or mre categorical variables.

Here is a box and whisker plot of the female penguins body mass data, with one box for each species. Note that we have used the same colour for each box. We already know which species is which, so to use different colours would imply an additional difference that isn't there. It would confuse the reader.

```{r}
#| label: fig-box-plots-symmetric
#| fig-cap: "Anatomy of a box and whisker plot. Here the data are symmetrically distributed"

bp1 <- female_penguins |>
  ggplot(aes(x = species, y = body_mass_g)) +
  geom_boxplot(fill = fill_colour1) +
  labs(x = "Species",
       y = "Body mass (g)") +
  annotate("text", x = 1.2, y = 2700, size = 3, label = "outlier", colour = "darkred") +
  annotate("text", x = 1.20, y = 3100, size = 3, label = "whisker", colour = "darkred") +
  annotate("text", x = 1.50, y = 3550, size = 3, label = "box", colour = "darkred") +
  annotate("text", x = 2.75, y = 4480, size = 3, label = "25th percentile", colour = "darkred") +
  annotate("text", x = 2.90, y = 4700, size = 3, label = "50th percentile (median)", colour = "darkred") +
  annotate("text", x = 2.75, y = 4850, size = 3, label = "75th percentile", colour = "darkred") +
  theme_cowplot()
bp1
```

In box and whisker plots, or box plots for short, we are shown a summary of the distribution of each data set and its central location. 

Consider @fig-box-plots-symmetric. 

Each **box** shows:

* the 75th percentile of the data: this is the top of the box
* the 50th percentile of the data ie the median: this is the thick black line somewhere across the box. If the dataset is symmetric, this line is in the middle of the box.
* the 25th percentile of the data: this is the bottom of the box
* the interquartile range ie rnage that contains the middle 50% of the data. This is the range of values between the top of the box and the bottom.

the **whiskers** show:

* the range of the rest of the data that goes beyond the interquartile range - ie how far uop and down the range top and bottom quartiles spread. 

any **outlier(s)** are shown by individual dots. Outliers are, more or less, jsut what the name says, daa values that are atypical of the rest of the data. 

A box plot can also show:

* whether there is a clear difference between the spread of values of the different catagories. Do the boxes overlap or are they clearly separated in the vertical direction? This helps us decide whether or not to reject a null hypothesis about there being no difference. 

In @fig-box-plots we can see that the body masses of Gentoo penguins are clearly greater than those of the other two species, but that there is no clear indication from these data that there is any difference between those two. 


* whether the distributions of the individual points  are of about the same width and if they are approximately symmetric. If they are, then perhaps the points are normally distributed about their means and have similar variances. In that case it may be possible to use so-called *parametric* tests for difference such as t-tests and ANOVAs of one kind or another. If not, then we may have to use their less powerful *non-parametric* equivalents such as Mann-Whitney tests or Kruskal-Wallis tests. 

We see in @fig-box-plots-symmetric that all the boxes are of about the same width, meaning the spread of values (the variance) is about the same for each species and  that all the plots are more or less symmetric, wit th emedians more or less in the middle. There is only one outlier which isn't too far out, and all the medians are more or less in the centre of the boxes, as we would expect fo a symmetric distribution. This means that the data pluasibly might be normally distributed. There is a better type of plot for determing normality, the quantile-quantile plot, but this quick check for normality from a box plot is a useful thing to be able to do.

For contrast, we show in @fig-box-plots-unsymmetrical what box plots can look like when you have data that really isn't normally distributed. You might get data like this if you were at the zoo and counting how many times an animal exhibited this or that behavioural trait in successive 20 minute blocks of time. In most blocks they either wouldn't exhibit the trait at all or maybe they would but only once, occasionally twice. *Very* occasionally they would have a splurge of activity and you'd get a high count. 

```{r}
#| label: fig-box-plots-unsymmetrical
#| caption: "Non symmetrical box plots. In this case the data are right skewed with outliers stretching out to high values untypical of the bulk of the data. On seeing this you would think no, those data don't look normally distributed and so no, I can't use a parametric test for difference such as a one-way ANOVA. I am going to need to use a non-parametric test such as, this case, a Kruskal-Wallis test."
bp2 <- data.frame(types = c(rep("A",100), rep("B", 100), rep("C", 100)), values = c(exp(rnorm(100,2,1)), exp(rnorm(100,3,1)), exp(rnorm(100,4,1)))) |>
  ggplot(aes(x = types, y = values)) +
  geom_boxplot(fill = fill_colour1) +
  labs(x = "Behaviour type",
       y = "Counts") 
bp2
```

### Improving the box plot

In its basic form the box plot does not show us the sample size or the internal detail of the sample distribution, for example whether it is bimodal or not.

We can fix that in at least a couple of ways as shown in @fig-box-plots-improved. We can add the sample sizes as annotations as we did with the bar charts, and/or we can the data points themselves, with a bit of sideways 'jitter' so that they don't all lie on top of each other. This can be effective if the sample size is not too large.

```{r}
#| label: fig-better-box-plots
#| fig-cap: "Anatomy of a box and whisker plot. Here the data are symmetrically distributed"

ns <- female_penguins |>
  group_by(species) |>
  summarise(n=n())

bp3 <- female_penguins |>
  ggplot(aes(x = species, y = body_mass_g)) +
  geom_boxplot(fill = fill_colour1) +
  
  labs(x = "Species",
       y = "Body mass (g)") +
  geom_text(data = ns, aes(y = 2000, label = paste("n = ",n)), vjust = 0, nudge_y = 200) +  
  theme_cowplot()

bp4 <- female_penguins |>
  ggplot(aes(x = species, y = body_mass_g)) +
  geom_boxplot(fill = fill_colour1, outlier.size = 0) +
  geom_jitter(width = 0.2, alpha =0.4) +
  labs(x = "Species",
       y = "Body mass (g)") +
  geom_text(data = ns, aes(y = 2000, label = paste("n = ",n)), vjust = 0, nudge_y = 200) +  
  theme_cowplot()
```
```{r}
#| label: fig-box-plots-improved
#| fig-cap: "Improved box plots"
#| fig-subcap: 
#|   - "Sample sizes added as annotations."
#|   - "Points added with some sideways jitter"
#| layout-ncol: 2

bp3
bp4
```







